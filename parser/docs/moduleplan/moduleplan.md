# 타로 LangGraph 모듈화 실행 계획

## 📋 개요

현재 `tarot_langgraph.py` 파일(4990줄)을 **LangGraph 공식 표준 프로젝트 구조**에 따라 모듈화하여 유지보수성과 확장성을 개선합니다. 이 계획은 기존 코드의 기능을 100% 유지하면서 모듈화를 진행합니다.

## 🏗️ 최종 디렉토리 구조

```
parsing/parser/
├── tarot_agent/                # 메인 에이전트 디렉토리
│   ├── utils/                  # 그래프를 위한 유틸리티들
│   │   ├── __init__.py         # 유틸리티 패키지 초기화
│   │   ├── state.py            # 그래프의 상태 정의
│   │   ├── tools.py            # 그래프를 위한 도구들 (@tool)
│   │   ├── nodes.py            # 그래프를 위한 노드 함수들
│   │   ├── web_search.py       # 웹 검색 관련 함수들
│   │   ├── analysis.py         # 카드 분석 관련 함수들
│   │   ├── timing.py           # 시간/타이밍 관련 함수들
│   │   ├── translation.py      # 번역 관련 함수들
│   │   └── helpers.py          # 기타 헬퍼 함수들
│   ├── __init__.py             # 에이전트 패키지 초기화
│   └── agent.py                # 그래프 구성 코드 + 메인 실행
├── tarot_rag_system.py         # 기존 RAG 시스템 (변경 없음)
└── tarot_langgraph.py          # 기존 파일 (참조용으로 유지)
```

## 🔄 단계별 실행 계획

### 1단계: 기본 디렉토리 구조 생성

1. `tarot_agent/` 디렉토리 생성
2. `tarot_agent/utils/` 디렉토리 생성
3. 모든 `__init__.py` 파일 생성

### 2단계: 핵심 상태 및 도구 분리

1. `utils/state.py` - TarotState 클래스 분리
   - 현재 코드 위치: 43-70줄
   - 모든 상태 정의를 그대로 유지

2. `utils/tools.py` - @tool 데코레이터 함수 분리
   - 현재 코드 위치: 4852-4872줄
   - RAG 시스템 초기화 함수 포함

### 3단계: 유틸리티 모듈 분리

3. `utils/web_search.py` - 웹 검색 관련 함수 분리
   - 현재 코드 위치: 79-318줄
   - 검색 도구 초기화, 검색 수행, 결과 통합 함수 포함

4. `utils/analysis.py` - 카드 분석 관련 함수 분리
   - 현재 코드 위치: 530-934줄
   - 확률 계산, 카드 분석, 시너지 분석 함수 포함

5. `utils/timing.py` - 시간/타이밍 관련 함수 분리
   - 현재 코드 위치: 408-478, 1083-1233줄
   - 시간 컨텍스트, 타이밍 예측, 시간 범위 포맷팅 함수 포함

6. `utils/translation.py` - 번역 관련 함수 분리
   - 현재 코드 위치: 1287-1334, 4704-4762줄
   - 영어-한국어 번역, 카드 정보 번역 함수 포함

7. `utils/helpers.py` - 기타 헬퍼 함수 분리
   - 현재 코드 위치: 1014-1041, 1401-1639, 기타 유틸리티 함수들
   - 타입 변환, 카드 번호 파싱, 키워드 추출 등 함수 포함

### 4단계: 노드 함수 분리

8. `utils/nodes.py` - 그래프 노드 함수 분리
   - 현재 코드 위치: 1731-4587줄
   - 모든 노드 및 핸들러 함수 포함
   - 필요한 유틸리티 모듈 임포트

### 5단계: 그래프 구성 및 메인 실행

9. `agent.py` - 그래프 구성 및 메인 실행 함수 분리
   - 현재 코드 위치: 1-42줄(임포트), 4762-4897줄(라우터 및 그래프 생성)
   - 필요한 모듈 임포트 및 그래프 구성 코드 포함

## 📊 테스트 계획

각 단계마다 다음 테스트를 진행하여 기능이 올바르게 작동하는지 확인합니다:

1. **모듈 임포트 테스트**: 각 모듈이 올바르게 임포트되는지 확인
2. **기능 단위 테스트**: 분리된 각 기능이 원래대로 작동하는지 확인
3. **통합 테스트**: 전체 시스템이 원래대로 작동하는지 확인

## 🚨 주의사항

1. **임포트 순환 참조 방지**: 모듈 간 순환 참조가 발생하지 않도록 주의
2. **전역 변수 처리**: 전역 변수는 적절한 모듈에 위치시키고 필요한 곳에서 임포트
3. **기존 코드 보존**: 모든 함수의 로직과 프롬프트를 그대로 유지
4. **RAG 시스템 로딩**: `tarot_rag_system.py`의 로딩이 중요하므로 올바르게 임포트되는지 확인

## 🔍 단계별 세부 실행 계획

### 1단계: 기본 디렉토리 구조 생성

```bash
# 디렉토리 생성
mkdir -p parsing/parser/tarot_agent/utils

# __init__.py 파일 생성
touch parsing/parser/tarot_agent/__init__.py
touch parsing/parser/tarot_agent/utils/__init__.py
```

### 2단계: 핵심 상태 및 도구 분리

#### `state.py` 생성
- TarotState 클래스 정의 (43-70줄)
- 필요한 임포트 추가

#### `tools.py` 생성
- @tool 데코레이터 함수 (4852-4872줄)
- RAG 시스템 초기화 함수 (4842-4851줄)
- 필요한 임포트 추가

### 3단계: 유틸리티 모듈 분리

각 유틸리티 모듈에 대해:
1. 관련 함수 식별
2. 필요한 임포트 추가
3. 함수 코드 복사
4. 전역 변수 처리

### 4단계: 노드 함수 분리

#### `nodes.py` 생성
- 모든 노드 및 핸들러 함수 (1731-4587줄)
- 필요한 유틸리티 모듈 임포트
- 전역 변수 처리

### 5단계: 그래프 구성 및 메인 실행

#### `agent.py` 생성
- 그래프 구성 및 메인 실행 함수 (4762-4897줄)
- 필요한 모듈 임포트
- 라우터 함수 (4762-4794줄)

## ⚠️ 잠재적 문제 및 해결 방안

1. **순환 참조 문제**
   - 해결: 함수 인자로 필요한 객체 전달, 임포트 시점 지연

2. **전역 변수 관리**
   - 해결: 전역 변수는 적절한 모듈에 정의하고 필요한 곳에서 임포트

3. **RAG 시스템 초기화**
   - 해결: `tools.py`에서 RAG 시스템 초기화 함수 정의 및 전역 변수 관리

4. **임포트 경로 문제**
   - 해결: 상대 경로 사용 및 필요시 `sys.path` 조정

## 🚀 최종 목표

1. **모듈화된 코드 구조**: LangGraph 표준을 따르는 모듈화된 코드 구조
2. **기능 보존**: 기존 코드의 모든 기능을 100% 보존
3. **유지보수성 향상**: 코드의 유지보수성과 확장성 개선
4. **테스트 용이성**: 모듈별 테스트가 용이한 구조

## 📅 일정

1. **1단계**: 기본 디렉토리 구조 생성 (1일)
2. **2-3단계**: 핵심 상태, 도구 및 유틸리티 모듈 분리 (2일)
3. **4단계**: 노드 함수 분리 (1일)
4. **5단계**: 그래프 구성 및 메인 실행 (1일)
5. **테스트 및 디버깅**: 전체 시스템 테스트 및 문제 해결 (2일)

총 예상 소요 시간: 7일 